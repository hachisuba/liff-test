<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>出勤一覧</title>


  <style>
    
    .btnSmall { padding: 8px 10px; border-radius: 10px; font-weight: 900; font-size: 12px; }
.btnRed { background:#d32f2f; }
.btnGreen2 { background:#2e7d32; }
.btnLight { background:#e0e0e0; color:#333; cursor:not-allowed; }

    body { font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; background:#f7f7f7; padding:14px; }
    .card { background:#fff; padding:14px; border-radius:12px; max-width: 980px; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 10px; font-size: 20px; text-align:center; }

    .sub { font-size: 12px; color:#666; text-align:center; margin-bottom: 8px; white-space: pre-wrap; }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap: wrap; margin: 10px 0; }
    .pill { display:inline-block; background:#f2f2f2; padding:4px 10px; border-radius:999px; font-size:12px; color:#333; }

    .btn { padding: 10px 12px; border: none; border-radius: 10px; color:#fff; font-weight: 900; cursor:pointer; }
    .btnGreen { background:#2e7d32; }
    .btnGray { background:#9e9e9e; cursor:not-allowed; }
    .btnBlue { background:#1976d2; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; font-size: 14px; vertical-align: top; }
    th { color:#555; font-weight:900; background:#fafafa; position: sticky; top: 0; }

    .msg { margin-top: 10px; text-align:center; white-space: pre-wrap; font-size: 14px; color:#333; }
    .err { color:#d32f2f; font-weight: 900; }

    /* ===== 処理中オーバーレイ（スピナー＋進捗バー） ===== */
    .busyOverlay{
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 16px;
    }
    .busyBox{
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    .busyTop{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .spinner{
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 3px solid #ddd;
      border-top-color: #06c755;
      animation: spin 0.9s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .busyTitle{ font-weight: 900; font-size: 15px; }
    .busyText{ font-size: 13px; color:#555; white-space: pre-wrap; }

    .barWrap{
      margin-top: 12px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .bar{
      height: 10px;
      width: 0%;
      background: #06c755;
      transition: width .25s ease;
    }
    .barMeta{
      display:flex;
      justify-content: space-between;
      font-size: 12px;
      color:#666;
      margin-top: 6px;
    }

    pre#debug {
      background:#111; color:#eee; padding:10px; border-radius:10px;
      font-size:12px; white-space:pre-wrap; margin-top: 12px;
      display:none;
    }

    /* ===== 登録モーダル ===== */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    .modalTitle { font-weight: 900; font-size: 16px; margin-bottom: 8px; }
    .modalText { font-size: 14px; color:#333; line-height: 1.6; white-space: pre-wrap; }
    .modalRow { display: grid; grid-template-columns: 1fr auto; gap: 8px; margin-top: 10px; }
    .modalMsg { margin-top: 10px; font-size: 13px; color:#d32f2f; white-space: pre-wrap; }
    .modalBtns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; }
    .hide { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>出勤一覧</h1>

    <div class="sub" id="who">読み込み中…</div>
    <div class="sub"><span class="pill" id="dateLabel"></span></div>

    <div class="row">
      <button class="btn btnBlue" id="reloadBtn">再読み込み</button>
      <button class="btn btnGray" id="toggleDebugBtn">デバッグ表示</button>
    </div>

    <div id="tableWrap"></div>

    <div class="msg" id="msg"></div>
    <pre id="debug"></pre>
  </div>

  <!-- 処理中オーバーレイ -->
  <div class="busyOverlay" id="busyOverlay">
    <div class="busyBox">
      <div class="busyTop">
        <div class="spinner"></div>
        <div>
          <div class="busyTitle" id="busyTitle">処理中…</div>
          <div class="busyText" id="busyText">少しだけお待ちください</div>
        </div>
      </div>
      <div class="barWrap"><div class="bar" id="busyBar"></div></div>
      <div class="barMeta">
        <div id="busyPct">0%</div>
        <div id="busyStep">1/3</div>
      </div>
    </div>
  </div>

  <!-- 初回登録モーダル -->
  <div class="overlay" id="overlayReg">
    <div class="modal">
      <div id="regStep1">
        <div class="modalTitle">あなたはまだ未登録です。</div>
        <div class="modalText">初回だけ、あなたのスタッフコード（半角数字）を入力してください。</div>
        <div class="modalRow">
          <input id="regStaffCode" placeholder="スタッフコード（半角数字）" inputmode="numeric" />
          <button class="btn btnGreen" id="regCheckBtn">確認</button>
        </div>
        <div class="modalMsg" id="regMsg1"></div>
      </div>

      <div id="regStep2" class="hide">
        <div class="modalTitle">確認</div>
        <div class="modalText" id="regConfirmText"></div>
        <div class="modalBtns">
          <button class="btn btnGray" id="regBackBtn">戻る</button>
          <button class="btn btnGreen" id="regDoBtn">登録</button>
        </div>
        <div class="modalMsg" id="regMsg2"></div>
      </div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    // ===== 固定（あなたの指定どおり） =====
    const LIFF_ID = "2008802899-oJWsorEf";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwqydPjkvk1bDvN4zlBxht64q5o-Grqe0O4oMG408zp09oFci9uB5-UG8qwiQf1vUEWEA/exec";

    // ===== 画面要素 =====
    const whoEl = document.getElementById("who");
    const msgEl = document.getElementById("msg");
    const tableWrap = document.getElementById("tableWrap");
    const dateLabel = document.getElementById("dateLabel");
    const debugEl = document.getElementById("debug");

    const busyOverlay = document.getElementById("busyOverlay");
    const busyTitle = document.getElementById("busyTitle");
    const busyText  = document.getElementById("busyText");
    const busyBar   = document.getElementById("busyBar");
    const busyPct   = document.getElementById("busyPct");
    const busyStep  = document.getElementById("busyStep");

    const reloadBtn = document.getElementById("reloadBtn");
    const toggleDebugBtn = document.getElementById("toggleDebugBtn");

    // 登録モーダル
    const overlayReg = document.getElementById("overlayReg");
    const regStep1 = document.getElementById("regStep1");
    const regStep2 = document.getElementById("regStep2");
    const regStaffCodeEl = document.getElementById("regStaffCode");
    const regMsg1 = document.getElementById("regMsg1");
    const regMsg2 = document.getElementById("regMsg2");
    const regConfirmText = document.getElementById("regConfirmText");
    const regCheckBtn = document.getElementById("regCheckBtn");
    const regBackBtn = document.getElementById("regBackBtn");
    const regDoBtn = document.getElementById("regDoBtn");

    let lineUserId = "";
    let lineDisplayName = "";
    let busyLock = false;

    // 登録用の一時保持
    let regCandidateCode = "";
    let regCandidateName = "";

    // ===== デバッグ =====
    function logDebug(text){
      debugEl.textContent += text + "\n";
    }
    function showError(title, detail){
      msgEl.innerText = title + "\n" + (detail || "");
      msgEl.classList.add("err");
      logDebug("[ERROR] " + title + " | " + (detail || ""));
    }
    window.onerror = function(message, source, lineno, colno){
      showError("JSエラー", message + " @" + lineno + ":" + colno);
    };

    toggleDebugBtn.addEventListener("click", () => {
      const isOpen = debugEl.style.display === "block";
      debugEl.style.display = isOpen ? "none" : "block";
      toggleDebugBtn.className = "btn " + (isOpen ? "btnGray" : "btnGreen");
    });

    reloadBtn.addEventListener("click", async () => {
      await loadAll();
    });

    // ===== JSTの今日（表示用） =====
    function getTodayKeyJst(){
      const parts = new Intl.DateTimeFormat("ja-JP", {
        timeZone: "Asia/Tokyo",
        year: "numeric", month: "2-digit", day: "2-digit"
      }).formatToParts(new Date());
      const y = parts.find(p => p.type === "year").value;
      const m = parts.find(p => p.type === "month").value;
      const d = parts.find(p => p.type === "day").value;
      return `${y}-${m}-${d}`;
    }

    function refreshDateLabel(){
      const today = getTodayKeyJst();
      dateLabel.innerText = `表示日：${today}`;
      return today;
    }

    // ===== 処理中UI =====
    function busyOn(title, text, step, totalSteps, pct){
      busyOverlay.style.display = "flex";
      busyTitle.textContent = title || "処理中…";
      busyText.textContent = text || "少しだけお待ちください";
      const p = Math.max(0, Math.min(100, pct || 0));
      busyBar.style.width = p + "%";
      busyPct.textContent = p + "%";
      busyStep.textContent = `${step || 1}/${totalSteps || 1}`;
      busyLock = true;
      reloadBtn.disabled = true;
      reloadBtn.className = "btn btnGray";
    }

    function busyOff(){
      busyOverlay.style.display = "none";
      busyBar.style.width = "0%";
      busyPct.textContent = "0%";
      busyStep.textContent = "1/1";
      busyLock = false;
      reloadBtn.disabled = false;
      reloadBtn.className = "btn btnBlue";
    }

    // ===== JSONP（CORS回避） =====
    function apiJson(params) {
      return new Promise((resolve, reject) => {
        const cbName = "cb" + Date.now() + Math.floor(Math.random()*1000);

        let script = null;

        window[cbName] = (data) => {
          try { delete window[cbName]; } catch(e){}
          if (script) script.remove();
          resolve(data);
        };

        const qs = new URLSearchParams();
        Object.entries(params).forEach(([k,v]) => qs.append(k, v));
        qs.append("callback", cbName);
        qs.append("cb", String(Date.now()));

        script = document.createElement("script");
        script.src = GAS_URL + "?" + qs.toString();
        script.onerror = () => {
          try { delete window[cbName]; } catch(e){}
          if (script) script.remove();
          reject(new Error("JSONP通信失敗（GASがcallbackで返してない/URLが違う可能性）"));
        };

        document.body.appendChild(script);
      });
    }

    // ===== 表 =====
    function renderTable(items){
  if (!items || !items.length){
    tableWrap.innerHTML = "";
    return;
  }

  let html = `
    <table>
      <thead>
        <tr>
          <th style="width: 30%;">店名</th>
          <th style="width: 30%;">開始日時</th>
          <th style="width: 25%;">名前</th>
          <th style="width: 15%;">確認</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (const it of items){
    const store = esc(it.store || "");
    const startAt = esc(it.startAt || "");
    const name = esc(it.name || "");
    const staffCode = String(it.staffCode || "");

    // Code.gsから返ってくる想定：confirmed / canConfirm
    const confirmed = !!it.confirmed;
    const canConfirm = !!it.canConfirm;

    let btnHtml = "";

    if (confirmed){
      // ✅ 確認済み（誰が見ても同じ）
      btnHtml = `<button class="btn btnLight btnSmall" disabled>確認済</button>`;
    } else if (canConfirm){
      // ✅ 本人だけ押せる
      btnHtml = `<button class="btn btnGreen2 btnSmall" onclick="onConfirm('${staffCode}')">確認</button>`;
    } else {
      // ✅ 本人以外は押せない（でも表示は出す）
      btnHtml = `<button class="btn btnLight btnSmall" disabled>未確認</button>`;
    }

    html += `
      <tr>
        <td>${store}</td>
        <td>${startAt}</td>
        <td>${name}</td>
        <td>${btnHtml}</td>
      </tr>
    `;
  }

  html += "</tbody></table>";
  tableWrap.innerHTML = html;
}


    function esc(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    async function onConfirm(staffCode){
  if (busyLock) return;

  const today = getTodayKeyJst();
  try {
    busyOn("送信中…", "出勤確認を送っています", 1, 1, 60);

    const res = await apiJson({
      action: "confirm",
      date: today,
      staffCode: String(staffCode || ""),
      userId: String(lineUserId || ""),
      displayName: String(lineDisplayName || "")
    });

    if (!res){
      busyOff();
      showError("通信失敗", "confirmの返りがありません");
      return;
    }
    if (!res.ok){
      busyOff();
      // TIMEOVERなど
      showError("確認できません", res.message || "NG");
      return;
    }

    busyOn("更新中…", "一覧を更新しています", 1, 1, 90);
    await loadAll(); // 再読み込みで表示更新
    busyOff();

  } catch (err){
    busyOff();
    showError("確認失敗", (err && err.message) ? err.message : String(err));
  }
}


    // ===== 登録モーダル =====
    function openRegisterModal(){
      overlayReg.style.display = "flex";
      regStep1.classList.remove("hide");
      regStep2.classList.add("hide");
      regMsg1.textContent = "";
      regMsg2.textContent = "";
      regStaffCodeEl.value = "";
      regCandidateCode = "";
      regCandidateName = "";
    }
    function closeRegisterModal(){
      overlayReg.style.display = "none";
    }
    function regBack(){
      regStep2.classList.add("hide");
      regStep1.classList.remove("hide");
      regMsg1.textContent = "";
      regMsg2.textContent = "";
    }

    regCheckBtn.addEventListener("click", async () => {
      if (busyLock) return;
      regMsg1.textContent = "";

      const code = (regStaffCodeEl.value || "").trim();
      if (!/^\d+$/.test(code)){
        regMsg1.textContent = "スタッフコードは半角数字で入力してください。";
        return;
      }

      try{
        busyOn("確認中…", "スタッフコードを照合しています", 1, 2, 35);
        const data = await apiJson({ action:"lookupStaff", staffCode: code });
        busyOn("確認中…", "結果を反映しています", 2, 2, 85);

        if (!data || !data.ok){
          busyOff();
          regMsg1.textContent = (data && data.message) ? data.message : "確認に失敗しました";
          return;
        }

        regCandidateCode = code;
        regCandidateName = data.name || "";
        regConfirmText.textContent = `あなたは、「${regCandidateName}」さんですね？\n間違いなければ「登録」を押してください。`;

        regStep1.classList.add("hide");
        regStep2.classList.remove("hide");
        regMsg2.textContent = "";
        busyOff();

      }catch(err){
        busyOff();
        regMsg1.textContent = (err && err.message) ? err.message : String(err);
      }
    });

    regBackBtn.addEventListener("click", () => regBack());

    regDoBtn.addEventListener("click", async () => {
      if (busyLock) return;
      regMsg2.textContent = "";

      if (!regCandidateCode){
        regMsg2.textContent = "スタッフコードが未確定です。最初からやり直してください。";
        return;
      }
      if (!lineUserId){
        regMsg2.textContent = "LINE情報が取得できていません。少し待ってからもう一度。";
        return;
      }

      try{
        busyOn("登録中…", "LINEとスタッフコードを紐づけています", 1, 2, 45);

        const data = await apiJson({
          action:"register",
          staffCode: regCandidateCode,
          userId: lineUserId,
          displayName: lineDisplayName
        });

        busyOn("登録中…", "画面を更新しています", 2, 2, 90);

        if (!data || !data.ok){
          busyOff();
          regMsg2.textContent = (data && data.message) ? data.message : "登録に失敗しました";
          return;
        }

        closeRegisterModal();
        msgEl.innerText = "登録しました。";
        busyOff();

        await loadListOnly(); // 登録後に一覧表示

      }catch(err){
        busyOff();
        regMsg2.textContent = (err && err.message) ? err.message : String(err);
      }
    });

    // ===== 一覧だけ読み込み =====
    async function loadListOnly(){
      const today = refreshDateLabel();
      busyOn("読み込み中…", "本日の出勤一覧を取得しています", 1, 1, 55);

      const data = await apiJson({ action:"list", date: today, userId: lineUserId });

      if (!data){
        busyOff();
        showError("通信失敗", "data が undefined です（GASが返していません）");
        return;
      }
      if (!data.ok){
        busyOff();
        showError("NG", data.message || "不明");
        return;
      }

      renderTable(data.items || []);
      msgEl.innerText = (data.items && data.items.length) ? "一覧を更新しました" : "出勤者がいません";
      busyOff();
    }

    // ===== メイン読み込み（meチェック → 未登録なら登録モーダル） =====
    async function loadAll(){
      if (busyLock) return;

      msgEl.classList.remove("err");
      msgEl.innerText = "";
      debugEl.textContent = "";
      logDebug("GAS_URL=" + GAS_URL);

      refreshDateLabel();

      try {
        busyOn("起動中…", "LINE情報を確認しています", 1, 3, 20);

        if (!window.liff){
          busyOff();
          showError("LIFFが読み込めません", "LINEアプリ内で開いてください");
          return;
        }

        await liff.init({ liffId: LIFF_ID });

        // ここが「access.line.me で拒否」系の人を止めるところ
        if (!liff.isInClient()){
          busyOff();
          showError("LINEアプリ内で開いてください", "このページはLINEアプリ内で開いた時だけ使えます。");
          return;
        }

        if (!liff.isLoggedIn()){
          whoEl.innerText = "LINEログインが必要です（ログインに進みます）";
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        lineUserId = profile.userId || "";
        lineDisplayName = profile.displayName || "";
        whoEl.innerText = `ログイン中：${lineDisplayName || "（名前取得できず）"}`;
        logDebug("userId=" + lineUserId);

        // ★ここが重要：登録判定（me）
        busyOn("確認中…", "登録状態を確認しています", 2, 3, 55);
        const me = await apiJson({ action:"me", userId: lineUserId });
        logDebug("me=" + JSON.stringify(me));

        // ★ registered=true でも staffCode が空なら「未登録扱い」にする（保険）
const isActuallyRegistered = !!me.registered && !!(me.staffCode || "").trim();

if (!isActuallyRegistered){
  busyOff();
  openRegisterModal();
  return;
}

        if (!me.registered){
          busyOff();
          openRegisterModal();
          return;
        }

        // 登録済み → 一覧
        busyOn("読み込み中…", "本日の出勤一覧を取得しています", 3, 3, 85);
        await loadListOnly();
        // loadListOnlyでbusyOffする

      } catch (err){
        busyOff();
        showError("読み込み失敗", (err && err.message) ? err.message : String(err));
      }
    }

    // 初回実行
    refreshDateLabel();
    loadAll();
  </script>
</body>
</html>
