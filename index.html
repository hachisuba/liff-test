<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出勤一覧</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#f5f6f8;margin:0;padding:14px;}
    .wrap{max-width:560px;margin:0 auto;}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:18px;}
    h1{margin:6px 0 10px;text-align:center;font-size:26px;}
    .sub{text-align:center;color:#666;font-size:14px;margin-bottom:6px;}
    .pill{display:inline-block;background:#eef0f3;border-radius:999px;padding:6px 10px;font-size:14px;}
    .center{text-align:center;}
    .btnrow{display:flex;gap:10px;justify-content:center;margin:12px 0 10px;}
    .btn{border:0;border-radius:10px;padding:10px 16px;color:#fff;font-weight:700;font-size:15px;cursor:pointer;}
    .btn.blue{background:#1976d2;}
    .btn.green{background:#2e7d32;}
    .status{margin:10px 0 0;text-align:center;color:#444;font-size:14px;min-height:20px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;font-size:15px;vertical-align:middle;}
    th{color:#666;font-weight:700;background:#fafafa;}
    .muted{color:#777;}
    .debug{display:none;margin-top:10px;background:#111;color:#e8e8e8;border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;}
    .spin{display:none;margin:8px auto 0;width:18px;height:18px;border-radius:50%;border:3px solid #ddd;border-top-color:#333;animation:rot .8s linear infinite;}
    @keyframes rot{to{transform:rotate(360deg)}}

    .btnSmall{border:0;border-radius:10px;padding:8px 10px;font-weight:800;font-size:13px;color:#fff;cursor:pointer;min-width:72px;}
    .btnRed{background:#d32f2f;}
    .btnDone{background:#2e7d32;}
    .btnGray{background:#bdbdbd; cursor:not-allowed;}

    .regBox{display:none;margin-top:14px;padding:12px;border-radius:14px;background:#fff5f5;border:1px solid #ffd3d3;}
    .regTitle{font-weight:900;color:#b71c1c;margin-bottom:8px;text-align:center;}
    .regRow{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;}
    .regInput{width:220px;max-width:70vw;padding:10px 12px;border-radius:10px;border:1px solid #ddd;font-size:15px;}
    .regBtn{background:#d32f2f;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;}
    .regBtn:disabled{background:#bdbdbd;cursor:not-allowed;}
    .regHint{margin-top:8px;color:#666;font-size:13px;text-align:center;}

    .modalBg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;padding:18px;z-index:9999;}
    .modal{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:420px;width:100%;padding:16px;}
    .modalTitle{font-weight:900;font-size:16px;text-align:center;margin-bottom:8px;}
    .modalText{font-size:14px;color:#333;text-align:center;line-height:1.6;white-space:pre-line;}
    .modalBtns{display:flex;gap:10px;justify-content:center;margin-top:12px;}
    .mBtn{border:0;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;}
    .mBack{background:#e0e0e0;color:#333;}
    .mOk{background:#d32f2f;color:#fff;}
    .mOk:disabled{background:#bdbdbd;cursor:not-allowed;}

    /* ===============================
       ★追加：処理中ポップアップ（半透明＋くるくる＋進捗）
       =============================== */
    #loadingOverlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      z-index:20000; /* modalより上にしたいので大きめ */
      align-items:center;
      justify-content:center;
      padding:18px;
      pointer-events:all; /* 裏操作を止める */
    }
    #loadingCard{
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
      max-width:420px;
      width:min(92vw, 360px);
      padding:16px;
      text-align:center;
    }
    #loadingSpinner{
      width:42px;height:42px;
      border-radius:999px;
      border:5px solid #eee;
      border-top-color:#555;
      animation:rot .9s linear infinite;
      margin:0 auto 10px;
    }
    #loadingMsg{
      font-weight:900;
      font-size:14px;
      color:#333;
      margin-bottom:10px;
      white-space:pre-line;
    }
    #progressBar{
      width:100%;
      height:10px;
      background:#eee;
      border-radius:999px;
      overflow:hidden;
    }
    #progressFill{
      height:100%;
      width:0%;
      background:#555;
      transition:width .2s ease;
    }
    #progressText{
      font-size:12px;
      color:#666;
      margin-top:6px;
    }
  </style>
</head>
<body>

  <!-- ===============================
       ★追加：処理中ポップアップ（body直下）
       =============================== -->
  <div id="loadingOverlay" aria-hidden="true">
    <div id="loadingCard" role="dialog" aria-modal="true" aria-label="処理中">
      <div id="loadingSpinner" aria-hidden="true"></div>
      <div id="loadingMsg">処理中…</div>
      <div id="progressBar" aria-hidden="true"><div id="progressFill"></div></div>
      <div id="progressText">0%</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1>出勤一覧</h1>

      <div class="sub">ログイン中：<span id="loginName">-</span></div>
      <div class="center"><span class="pill">表示日：<span id="viewDate">-</span></span></div>

      <div class="regBox" id="regBox">
        <div class="regTitle">スタッフ登録が必要です</div>
        <div class="regRow">
          <input class="regInput" id="regStaffCode" placeholder="スタッフコード（半角数字）" inputmode="numeric" autocomplete="off" />
          <button class="regBtn" id="regBtn" disabled>確認</button>
        </div>
        <div class="regHint" id="regHint">※スタッフコード未登録時のみ入力が必要。</div>
      </div>

      <div class="btnrow">
        <button class="btn blue" id="btnReload">再読み込み</button>
        <button class="btn green" id="btnDebug">デバッグ表示</button>
      </div>

      <div class="spin" id="loading"></div>

      <table>
        <thead>
          <tr>
            <th style="width:34%">店名</th>
            <th style="width:26%">開始日時</th>
            <th style="width:26%">名前</th>
            <th style="width:14%">確認</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="muted" colspan="4" style="text-align:center">読み込み中…</td></tr>
        </tbody>
      </table>

      <div class="status" id="statusText"></div>
      <div class="debug" id="debugBox"></div>
    </div>
  </div>

  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div class="modalTitle">確認</div>
      <div class="modalText" id="modalText">-</div>
      <div class="modalBtns">
        <button class="mBtn mBack" id="modalBack">戻る</button>
        <button class="mBtn mOk" id="modalOk">登録</button>
      </div>
    </div>
  </div>

<script>
  /* ===============================
  固定情報（変更しない）
  =============================== */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwqydPjkvk1bDvN4zlBxht64q5o-Grqe0O4oMG408zp09oFci9uB5-UG8qwiQf1vUEWEA/exec";
  const LIFF_ID = "2008802899-oJWsorEf";

  let debugOn = false;
  let inflight = false;

  let myUserId = "";
  let myDisplayName = "";
  let myStaffCode = "";

  let pendingStaffCode = "";
  let pendingStaffName = "";

  const elLoginName  = document.getElementById("loginName");
  const elViewDate   = document.getElementById("viewDate");
  const elTbody      = document.getElementById("tbody");
  const elStatus     = document.getElementById("statusText");
  const elDebug      = document.getElementById("debugBox");
  const elLoading    = document.getElementById("loading");

  const elRegBox     = document.getElementById("regBox");
  const elRegCode    = document.getElementById("regStaffCode");
  const elRegBtn     = document.getElementById("regBtn");

  const elModalBg    = document.getElementById("modalBg");
  const elModalText  = document.getElementById("modalText");
  const elModalBack  = document.getElementById("modalBack");
  const elModalOk    = document.getElementById("modalOk");

  /* ===============================
     ★追加：処理中オーバーレイ制御（連打防止）
     - “本当の%”ではなく、待ち時間が分かるように増えていく表示
     =============================== */
  const elOverlay = document.getElementById("loadingOverlay");
  const elOverlayMsg = document.getElementById("loadingMsg");
  const elProgressFill = document.getElementById("progressFill");
  const elProgressText = document.getElementById("progressText");
  let progressTimer = null;
  let fakeProgress = 0;

  function overlayStart_(msg){
    // メッセージ
    elOverlayMsg.textContent = msg || "処理中…";

    // 進捗 初期化
    fakeProgress = 0;
    elProgressFill.style.width = "0%";
    elProgressText.textContent = "0%";

    // 表示
    elOverlay.style.display = "flex";
    elOverlay.setAttribute("aria-hidden","false");

    // スクロール止め（誤操作防止）
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";

    // “それっぽい進捗”を90%まで上げる
    clearInterval(progressTimer);
    progressTimer = setInterval(() => {
      // 早すぎないように少しずつ
      fakeProgress = Math.min(fakeProgress + (5 + Math.random()*10), 90);
      elProgressFill.style.width = Math.floor(fakeProgress) + "%";
      elProgressText.textContent = Math.floor(fakeProgress) + "%";
    }, 350);
  }

  function overlayUpdate_(msg){
    if(!elOverlay || elOverlay.style.display !== "flex") return;
    if(msg) elOverlayMsg.textContent = msg;
  }

  function overlayEnd_(){
    clearInterval(progressTimer);
    progressTimer = null;

    // 100%にしてから消す
    elProgressFill.style.width = "100%";
    elProgressText.textContent = "100%";

    setTimeout(() => {
      elOverlay.style.display = "none";
      elOverlay.setAttribute("aria-hidden","true");
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }, 150);
  }

  // ✅ 既存：setLoading(on) を“中身だけ”拡張（呼び出し箇所は変更しない）
  function setLoading(on){
    elLoading.style.display = on ? "block" : "none";

    if(on){
      // statusText に入っている文言を優先して表示
      overlayStart_(elStatus.textContent || "処理中…");
    }else{
      overlayEnd_();
    }
  }

  function setStatus(msg){
    elStatus.textContent = msg || "";
    // ★追加：処理中はメッセージも追従させる
    if (inflight) overlayUpdate_(elStatus.textContent || "処理中…");
  }

  function setDebug(text){
    elDebug.textContent = text || "";
    elDebug.style.display = debugOn ? "block" : "none";
  }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
  function showRegister_(on){ elRegBox.style.display = on ? "block" : "none"; }
  function showModal_(on){ elModalBg.style.display = on ? "flex" : "none"; }

  // ✅ 最小追加：スタッフコードの表示ゆれを吸収（"10277.0" → "10277" など）
  function normStaffCode_(v){
    let s = String(v ?? "").trim();
    if (!s) return "";
    // 末尾の ".0" だけ落とす（スプレッドシート由来の数値文字列対策）
    s = s.replace(/\.0+$/,"");
    return s;
  }

  function callJsonp_(paramsObj) {
    return new Promise((resolve, reject) => {
      const cb = "__cb_" + Date.now() + "_" + Math.floor(Math.random()*1000);
      const timeout = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 15000);
      let sc = null;

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cb]; } catch(_) {}
        if (sc && sc.parentNode) sc.parentNode.removeChild(sc);
      }
      window[cb] = (data) => { cleanup(); resolve(data); };

      const qs = new URLSearchParams(paramsObj || {});
      qs.set("callback", cb);
      qs.set("t", String(Date.now()));

      sc = document.createElement("script");
      sc.src = `${GAS_URL}?${qs.toString()}`;
      sc.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
      document.body.appendChild(sc);
    });
  }

  function getListByJsonp_(){ return callJsonp_({ action:"list" }); }
  function getMeByJsonp_(){ return callJsonp_({ action:"me", userId: myUserId, displayName: myDisplayName || "" }); }
  function getLookupByJsonp_(staffCode){ return callJsonp_({ action:"lookup", staffCode: String(staffCode||"") }); }
  function getRegisterByJsonp_(staffCode){
    return callJsonp_({ action:"register", userId: myUserId, displayName: myDisplayName || "", staffCode: String(staffCode||"") });
  }
  function getApplyByJsonp_(){ return callJsonp_({ action:"apply", userId: myUserId, displayName: myDisplayName || "" }); }

function renderRows(rows){
  if(!rows || !rows.length){
    elTbody.innerHTML = `<tr><td class="muted" colspan="4" style="text-align:center">出勤者がいません</td></tr>`;
    return;
  }

  const myCode = normStaffCode_(myStaffCode); // ✅ 正規化してから比較
  elTbody.innerHTML = rows.map(r => {
    const rowCode = normStaffCode_(r.staffCode); // ✅ 正規化してから比較
    const confirmed = !!r.confirmed;

    // ✅ 本人判定（そのまま）
    const isSelf = (myCode && rowCode && myCode === rowCode);

    let btnHtml = "";
    if (confirmed) {
      btnHtml = `<button class="btnSmall btnDone" disabled>完了</button>`;
    } else if (isSelf) {
      btnHtml = `<button class="btnSmall btnRed" data-action="apply">申請</button>`;
    } else {
      btnHtml = `<button class="btnSmall btnGray" disabled>未</button>`;
    }

    // ✅ 追加：スタッフコードを名前の上に表示（rowCodeがある時だけ）
    const staffCodeHtml = rowCode
      ? `<div style="font-size:12px;color:#666;font-weight:700;line-height:1.1;">${esc(rowCode)}</div>`
      : "";

    return `
      <tr>
        <td>${esc(r.store||"")}</td>
        <td>${esc(r.start||"")}</td>
        <td>
          ${staffCodeHtml}
          <div>${esc(r.name||"")}</div>
        </td>
        <td style="text-align:right">${btnHtml}</td>
      </tr>
    `;
  }).join("");
}


  async function loadAll(){
    if(inflight) return;
    inflight = true;
    setLoading(true);
    setStatus("読み込み中…");

    try{
      const list = await getListByJsonp_();
      if (!list || list.ok === false) throw new Error(list?.message || list?.error || "server_ng");

      elViewDate.textContent = list.viewDate || list.today || "-";
      renderRows(list.rows || []);
      setStatus("一覧を更新しました");
      setDebug(JSON.stringify({ me:{ myUserId, myStaffCode, myDisplayName }, list }, null, 2));
    }catch(e){
      setStatus("読み込み失敗");
      renderRows([]);
      setDebug(String(e));
    }finally{
      setLoading(false);
      inflight = false;
    }
  }

  async function refreshMeUi_(){
    myStaffCode = "";
    try{
      const me = await getMeByJsonp_();
      if (me && me.ok && me.staffCode) {
        myStaffCode = normStaffCode_(me.staffCode);  // ✅ ここも正規化
        showRegister_(false);
        return;
      }
    }catch(_){}
    showRegister_(true);
  }

  async function initLiff_(){
    try{
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        elLoginName.textContent = "（LINEで開いてください）";
        setStatus("LINEで開いてください");
        showRegister_(false);
        return;
      }

      const prof = await liff.getProfile();
      myUserId = prof.userId || "";
      myDisplayName = prof.displayName || "";
      elLoginName.textContent = myDisplayName || "-";

      await refreshMeUi_();

      const refreshRegBtn = () => {
        const v = String(elRegCode.value || "").trim();
        elRegBtn.disabled = !(v && /^\d+$/.test(v) && myUserId);
      };
      elRegCode.addEventListener("input", () => {
        elRegCode.value = String(elRegCode.value||"").replace(/[^\d]/g,"");
        refreshRegBtn();
      });
      refreshRegBtn();

      elRegBtn.addEventListener("click", async () => {
        if(inflight) return;
        const staffCode = String(elRegCode.value || "").trim();
        if (!staffCode || !/^\d+$/.test(staffCode)) return;

        inflight = true;
        setLoading(true);
        setStatus("照合中…");

        try{
          const res = await getLookupByJsonp_(staffCode);
          if (!res || res.ok === false) throw new Error(res?.message || res?.error || "lookup_ng");

          if (res.alreadyLinked) {
            setStatus("登録済みです");
            showRegister_(false);
            await refreshMeUi_();
            await loadAll();
            return;
          }

          pendingStaffCode = staffCode;
          pendingStaffName = String(res.name || "").trim();
          elModalText.textContent =
            `あなたは「${pendingStaffName || "（名前未設定）"}」さんですね。\n登録してよろしいでしょうか？`;
          elModalOk.disabled = false;
          showModal_(true);
          setStatus("");
        }catch(e){
          setStatus("照合失敗");
          setDebug(String(e));
        }finally{
          setLoading(false);
          inflight = false;
        }
      });

    }catch(e){
      elLoginName.textContent = "（LINEで開いてください）";
      setStatus("LINEで開いてください");
      showRegister_(false);
      setDebug(String(e));
    }
  }

  elModalBack.addEventListener("click", () => {
    showModal_(false);
    pendingStaffCode = "";
    pendingStaffName = "";
  });

  elModalOk.addEventListener("click", async () => {
    if(inflight) return;
    if(!pendingStaffCode) return;

    inflight = true;
    setLoading(true);
    setStatus("登録中…");

    try{
      const res = await getRegisterByJsonp_(pendingStaffCode);
      if (!res || res.ok === false) throw new Error(res?.message || res?.error || "register_ng");

      showModal_(false);
      pendingStaffCode = "";
      pendingStaffName = "";

      await refreshMeUi_();
      await loadAll();

      setStatus("登録しました");
    }catch(e){
      setStatus("登録失敗");
      setDebug(String(e));
    }finally{
      setLoading(false);
      inflight = false;
    }
  });

  elTbody.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button[data-action='apply']");
    if(!btn) return;
    if(inflight) return;

    inflight = true;
    setLoading(true);
    setStatus("申請中…");

    try{
      const res = await getApplyByJsonp_();
      if (!res || res.ok === false) throw new Error(res?.message || res?.error || "apply_ng");
      await loadAll();
      setStatus("申請しました（完了）");
    }catch(e){
      setStatus("申請失敗");
      setDebug(String(e));
    }finally{
      setLoading(false);
      inflight = false;
    }
  });

  document.getElementById("btnReload").addEventListener("click", async () => {
    await refreshMeUi_();
    await loadAll();
  });

  document.getElementById("btnDebug").addEventListener("click", () => {
    debugOn = !debugOn;
    elDebug.style.display = debugOn ? "block" : "none";
  });

  document.addEventListener("DOMContentLoaded", async () => {
    await initLiff_();
    await loadAll();
  });
</script>
</body>
</html>
