<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出勤一覧</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#f5f6f8;margin:0;padding:14px;}
    .wrap{max-width:560px;margin:0 auto;}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:18px;}
    h1{margin:6px 0 10px;text-align:center;font-size:26px;}
    .sub{text-align:center;color:#666;font-size:14px;margin-bottom:6px;}
    .pill{display:inline-block;background:#eef0f3;border-radius:999px;padding:6px 10px;font-size:14px;}
    .center{text-align:center;}
    .btnrow{display:flex;gap:10px;justify-content:center;margin:12px 0 10px;}
    .btn{border:0;border-radius:10px;padding:10px 16px;color:#fff;font-weight:700;font-size:15px;cursor:pointer;}
    .btn.blue{background:#1976d2;}
    .btn.green{background:#2e7d32;}
    .status{margin:10px 0 0;text-align:center;color:#444;font-size:14px;min-height:20px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;font-size:15px;vertical-align:middle;}
    th{color:#666;font-weight:700;background:#fafafa;}
    .muted{color:#777;}
    .debug{display:none;margin-top:10px;background:#111;color:#e8e8e8;border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;}
    .spin{display:none;margin:8px auto 0;width:18px;height:18px;border-radius:50%;border:3px solid #ddd;border-top-color:#333;animation:rot .8s linear infinite;}
    @keyframes rot{to{transform:rotate(360deg)}}

    .btnSmall{border:0;border-radius:10px;padding:8px 10px;font-weight:800;font-size:13px;color:#fff;cursor:pointer;min-width:72px;}
    .btnRed{background:#d32f2f;}
    .btnDone{background:#2e7d32;}
    .btnGray{background:#bdbdbd; cursor:not-allowed;}
    .selfTag{display:inline-block;font-size:11px;font-weight:800;margin-left:6px;background:#ffe8e8;color:#b71c1c;border-radius:999px;padding:2px 8px;}

    .regBox{display:none;margin-top:14px;padding:12px;border-radius:14px;background:#fff5f5;border:1px solid #ffd3d3;}
    .regTitle{font-weight:900;color:#b71c1c;margin-bottom:8px;text-align:center;}
    .regRow{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;}
    .regInput{width:220px;max-width:70vw;padding:10px 12px;border-radius:10px;border:1px solid #ddd;font-size:15px;}
    .regBtn{background:#d32f2f;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;}
    .regBtn:disabled{background:#bdbdbd;cursor:not-allowed;}
    .regHint{margin-top:8px;color:#666;font-size:13px;text-align:center;}

    .modalBg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;padding:18px;z-index:9999;}
    .modal{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:420px;width:100%;padding:16px;}
    .modalTitle{font-weight:900;font-size:16px;text-align:center;margin-bottom:8px;}
    .modalText{font-size:14px;color:#333;text-align:center;line-height:1.6;white-space:pre-line;}
    .modalBtns{display:flex;gap:10px;justify-content:center;margin-top:12px;}
    .mBtn{border:0;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;}
    .mBack{background:#e0e0e0;color:#333;}
    .mOk{background:#d32f2f;color:#fff;}
    .mOk:disabled{background:#bdbdbd;cursor:not-allowed;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>出勤一覧</h1>

      <div class="sub">ログイン中：<span id="loginName">-</span></div>
      <div class="center"><span class="pill">表示日：<span id="viewDate">-</span></span></div>

      <div class="regBox" id="regBox">
        <div class="regTitle">スタッフ登録が必要です</div>
        <div class="regRow">
          <input class="regInput" id="regStaffCode" placeholder="スタッフコード（半角数字）" inputmode="numeric" autocomplete="off" />
          <button class="regBtn" id="regBtn" disabled>確認</button>
        </div>
        <div class="regHint" id="regHint">※ LINE userId（U〜）は自動取得して登録します</div>
      </div>

      <div class="btnrow">
        <button class="btn blue" id="btnReload">再読み込み</button>
        <button class="btn green" id="btnDebug">デバッグ表示</button>
      </div>

      <div class="spin" id="loading"></div>

      <table>
        <thead>
          <tr>
            <th style="width:34%">店名</th>
            <th style="width:26%">開始日時</th>
            <th style="width:26%">名前</th>
            <th style="width:14%">操作</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="muted" colspan="4" style="text-align:center">読み込み中…</td></tr>
        </tbody>
      </table>

      <div class="status" id="statusText"></div>
      <div class="debug" id="debugBox"></div>
    </div>
  </div>

  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div class="modalTitle">確認</div>
      <div class="modalText" id="modalText">-</div>
      <div class="modalBtns">
        <button class="mBtn mBack" id="modalBack">戻る</button>
        <button class="mBtn mOk" id="modalOk">登録</button>
      </div>
    </div>
  </div>

<script>
  /* ===============================
  固定情報（必要なら更新する場所）
  =============================== */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwqydPjkvk1bDvN4zlBxht64q5o-Grqe0O4oMG408zp09oFci9uB5-UG8qwiQf1vUEWEA/exec";
  const LIFF_ID = "2008802899-oJWsorEf";

  let debugOn = false;
  let inflight = false;

  let myUserId = "";
  let myDisplayName = "";
  let myStaffCode = "";
  let myName = "";
  let meOk = false;

  let pendingStaffCode = "";
  let pendingStaffName = "";

  const elLoginName = document.getElementById("loginName");
  const elViewDate  = document.getElementById("viewDate");
  const elTbody     = document.getElementById("tbody");
  const elStatus    = document.getElementById("statusText");
  const elDebug     = document.getElementById("debugBox");
  const elLoading   = document.getElementById("loading");

  const elRegBox  = document.getElementById("regBox");
  const elRegCode = document.getElementById("regStaffCode");
  const elRegBtn  = document.getElementById("regBtn");
  const elRegHint = document.getElementById("regHint");

  const elModalBg   = document.getElementById("modalBg");
  const elModalText = document.getElementById("modalText");
  const elModalBack = document.getElementById("modalBack");
  const elModalOk   = document.getElementById("modalOk");

  function setLoading(on){ elLoading.style.display = on ? "block" : "none"; }
  function setStatus(msg){ elStatus.textContent = msg || ""; }
  function setDebug(text){
    elDebug.textContent = text || "";
    el
