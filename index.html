<!-- ===============================
GitHub側 index.html（完成版 / LIFF対応）
配置先：https://hachisuba.github.io/liff-test/
=============================== -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出勤一覧</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#f5f6f8;margin:0;padding:14px;}
    .wrap{max-width:520px;margin:0 auto;}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:18px;}
    h1{margin:6px 0 10px;text-align:center;font-size:26px;}
    .sub{text-align:center;color:#666;font-size:14px;margin-bottom:6px;}
    .pill{display:inline-block;background:#eef0f3;border-radius:999px;padding:6px 10px;font-size:14px;}
    .center{text-align:center;}
    .btnrow{display:flex;gap:10px;justify-content:center;margin:12px 0 10px;}
    .btn{border:0;border-radius:10px;padding:10px 16px;color:#fff;font-weight:700;font-size:15px;cursor:pointer;}
    .btn.blue{background:#1976d2;}
    .btn.green{background:#2e7d32;}
    .status{margin:10px 0 0;text-align:center;color:#444;font-size:14px;min-height:20px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;font-size:15px;}
    th{color:#666;font-weight:700;background:#fafafa;}
    .muted{color:#777;}
    .debug{display:none;margin-top:10px;background:#111;color:#e8e8e8;border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;}
    .spin{display:none;margin:8px auto 0;width:18px;height:18px;border-radius:50%;border:3px solid #ddd;border-top-color:#333;animation:rot .8s linear infinite;}
    @keyframes rot{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>出勤一覧</h1>

      <div class="sub">ログイン中：<span id="loginName">-</span></div>
      <div class="center"><span class="pill">表示日：<span id="viewDate">-</span></span></div>

      <div class="btnrow">
        <button class="btn blue" id="btnReload">再読み込み</button>
        <button class="btn green" id="btnDebug">デバッグ表示</button>
      </div>

      <div class="spin" id="loading"></div>

      <table>
        <thead>
          <tr>
            <th style="width:40%">店名</th>
            <th style="width:35%">開始日時</th>
            <th style="width:25%">名前</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="muted" colspan="3" style="text-align:center">読み込み中…</td></tr>
        </tbody>
      </table>

      <div class="status" id="statusText"></div>
      <div class="debug" id="debugBox"></div>
    </div>
  </div>
<script>
  // ★GAS WebApp（固定）
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwqydPjkvk1bDvN4zlBxht64q5o-Grqe0O4oMG408zp09oFci9uB5-UG8qwiQf1vUEWEA/exec";

  // ★表示日（JSTの今日）※サーバ値が来たら上書き
  function jstTodayYmd() {
    const d = new Date();
    const s = d.toLocaleDateString("ja-JP", { timeZone: "Asia/Tokyo" }); // 2026/1/5 みたいな
    // 0埋めしたいなら追加で整形するけど、表示だけならこれでOK
    return s;
  }

  document.addEventListener("DOMContentLoaded", () => {
    // まず保険で表示
    const todayEl = document.getElementById("today");
    if (todayEl) todayEl.textContent = jstTodayYmd();

    // 一覧を取得（JSONP）
    loadListJsonp();
  });

  function loadListJsonp() {
    const statusEl = document.getElementById("status");
    if (statusEl) statusEl.textContent = "読み込み中…";

    const cb = "onListLoaded_" + Date.now();
    window[cb] = (json) => {
      try {
        if (!json || !json.ok) {
          if (statusEl) statusEl.textContent = "読み込み失敗（データが不正）";
          return;
        }

        // サーバの今日（JST）で表示を上書き
        const todayEl = document.getElementById("today");
        if (todayEl && json.today) todayEl.textContent = json.today;

        renderList(json.items || []);
        if (statusEl) statusEl.textContent = (json.items && json.items.length)
          ? `本日の一覧：${json.items.length}件`
          : "出勤者がいません";
      } finally {
        // scriptタグ掃除
        delete window[cb];
      }
    };

    const url = `${GAS_WEBAPP_URL}?action=list&callback=${encodeURIComponent(cb)}&t=${Date.now()}`;
    const sc = document.createElement("script");
    sc.src = url;
    sc.onerror = () => {
      if (statusEl) statusEl.textContent = "読み込み失敗（通信エラー）";
    };
    document.body.appendChild(sc);
  }

  function renderList(items) {
    const listEl = document.getElementById("list");
    if (!listEl) return;
    listEl.innerHTML = "";

    for (const it of items) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div><b>${esc(it.place || "")}</b></div>
        <div class="muted">${esc(it.status || "")}</div>
        <div style="margin-top:6px;">${esc(it.sei || "")} ${esc(it.mei || "")}</div>
      `;
      listEl.appendChild(div);
    }
  }

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
</script>

<script>
/* ===============================
固定情報（必要なら更新する場所）
=============================== */

// ★更新した場合はここを修正：GAS WebアプリURL（/exec）
const GAS_URL = "https://script.google.com/macros/s/AKfycbwqydPjkvk1bDvN4zlBxht64q5o-Grqe0O4oMG408zp09oFci9uB5-UG8qwiQf1vUEWEA/exec";

// ★更新した場合はここを修正：LIFF_ID
const LIFF_ID = "2008802899-oJWsorEf";

// ★チャンネルアクセストークンは “フロントに置かない”（漏れる）ので、このページでは使いません。
// （運用で必要になったらGAS側/サーバ側に置く）

/* ===============================
画面用
=============================== */
let debugOn = false;
let inflight = false;
let aliveReq = 0;

const elLoginName = document.getElementById("loginName");
const elViewDate  = document.getElementById("viewDate");
const elTbody     = document.getElementById("tbody");
const elStatus    = document.getElementById("statusText");
const elDebug     = document.getElementById("debugBox");
const elLoading   = document.getElementById("loading");

function setLoading(on){ elLoading.style.display = on ? "block" : "none"; }
function setStatus(msg){ elStatus.textContent = msg || ""; }
function setDebug(text){
  elDebug.textContent = text || "";
  elDebug.style.display = debugOn ? "block" : "none";
}
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}
function renderRows(rows){
  if(!rows || !rows.length){
    elTbody.innerHTML = `<tr><td class="muted" colspan="3" style="text-align:center">出勤者がいません</td></tr>`;
    return;
  }
  elTbody.innerHTML = rows.map(r => `
    <tr>
      <td>${esc(r.store||"")}</td>
      <td>${esc(r.start||"")}</td>
      <td>${esc(r.name||"")}</td>
    </tr>
  `).join("");
}

/* ===============================
JSONP（CORS回避）→ GAS doGet(action=...) に当てる
=============================== */
function jsonp(url, timeoutMs = 12000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
    const s = document.createElement("script");
    const sep = url.includes("?") ? "&" : "?";
    const full = url + sep + "callback=" + encodeURIComponent(cb);

    let timer = setTimeout(() => {
      cleanup();
      reject(new Error("timeout"));
    }, timeoutMs);

    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if (s && s.parentNode) s.parentNode.removeChild(s);
      clearTimeout(timer);
    }

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      cleanup();
      reject(new Error("script_error"));
    };

    s.src = full;
    document.body.appendChild(s);
  });
}

function buildApiUrl(params){
  const u = new URL(GAS_URL);
  Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
  return u.toString();
}

async function apiStrong(params, opt = {}){
  const { retry = 2, timeoutMs = 12000 } = opt;
  let lastErr;
  for (let i=0;i<=retry;i++){
    try{
      const url = buildApiUrl(params);
      const data = await jsonp(url, timeoutMs);
      return data;
    }catch(e){
      lastErr = e;
      if(i===retry) throw lastErr;
      await new Promise(r=>setTimeout(r, 500*(i+1)));
    }
  }
  throw lastErr;
}

/* ===============================
LIFFログイン → userId取得 → me/list
=============================== */
let userId = "";
let displayName = "";

async function initLiff(){
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    // LIFF内では基本ログインされる想定。未ログインならログインへ。
    liff.login({ redirectUri: location.href });
    return;
  }

  const profile = await liff.getProfile();
  userId = profile.userId || "";
  displayName = profile.displayName || "";

  elLoginName.textContent = displayName || "-";
}

async function loadAll_once(){
  if(inflight) return;
  inflight = true;

  const reqId = ++aliveReq;
  setLoading(true);
  setStatus("読み込み中…");

  try{
    // ① me
    const me = await apiStrong({ action:"me", userId }, { retry: 1, timeoutMs: 12000 });
    if(reqId !== aliveReq) return;

    if(me && me.registered && me.name){
      elLoginName.textContent = me.name;
    } else {
      // 未登録ならLIFFの表示名（登録画面は別途追加できる）
      elLoginName.textContent = displayName || "-";
    }

    // ② list
    const list = await apiStrong({ action:"list", userId }, { retry: 2, timeoutMs: 12000 });
    if(reqId !== aliveReq) return;

    if(list.ok === false) throw new Error(list.message || "ng");

    elViewDate.textContent = list.viewDate || "-";
    renderRows(list.rows || []);
    setStatus("一覧を更新しました");

    setDebug(
`GAS_URL=${GAS_URL}
LIFF_ID=${LIFF_ID}
userId=${userId}
me=${JSON.stringify(me)}
list=${JSON.stringify(list)}`
    );

  }catch(e){
    if(reqId !== aliveReq) return;
    setStatus("読み込み失敗");
    renderRows([]);
    setDebug(String(e));
  }finally{
    if(reqId === aliveReq) setLoading(false);
    inflight = false;
  }
}

document.getElementById("btnReload").addEventListener("click", loadAll_once);
document.getElementById("btnDebug").addEventListener("click", () => {
  debugOn = !debugOn;
  elDebug.style.display = debugOn ? "block" : "none";
});

document.addEventListener("DOMContentLoaded", async () => {
  try{
    await initLiff();
    await loadAll_once();
  }catch(e){
    setStatus("読み込み失敗");
    setDebug(String(e));
  }
});
</script>
</body>
</html>
