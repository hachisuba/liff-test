<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出勤確認（自動送信テスト）</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; margin: 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .title { font-size: 18px; font-weight: 800; }
    .sub { font-size: 12px; color: #666; margin-top: 4px; }
    .ok { background: #e8fff0; border-color: #b7f0c5; }
    .ng { background: #ffecec; border-color: #f5b5b5; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre-wrap; word-break: break-all; }
  </style>
</head>

<body>
  <div class="card">
    <div class="title">出勤確認（自動送信）</div>
    <div class="sub">LIFFでログインできたら userId を自動でGASへ送ります</div>
  </div>

  <div id="status" class="card"><b>状態</b><div id="statusText">起動中…</div></div>

  <div class="card">
    <b>userId</b>
    <div id="userId" class="mono">未取得</div>
  </div>

  <div class="card">
    <b>表示名</b>
    <div id="displayName" class="mono">未取得</div>
  </div>

  <div id="result" class="card">
    <b>送信結果</b>
    <div id="resultText" class="mono">未送信</div>
  </div>

  <div class="card">
    <b>デバッグ</b>
    <div id="debug" class="mono"></div>
  </div>

<script>
  // ========= ここだけ変える =========
  const LIFF_ID = "2008802899-oJWsorEf"; // せなさんのLIFF ID
  const GAS_ENDPOINT = "ここにGASの /exec URL を貼る"; // 例: https://script.google.com/macros/s/XXXX/exec
  // ================================

  const $ = (id) => document.getElementById(id);

  function setStatus(text, ok=true) {
    $("statusText").textContent = text;
    $("status").className = "card " + (ok ? "ok" : "ng");
  }

  function logDebug(obj) {
    const t = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    $("debug").textContent += (t + "\n");
  }

  async function postToGas(payload) {
    const res = await fetch(GAS_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const txt = await res.text();
    let json = null;
    try { json = JSON.parse(txt); } catch (_) {}
    return { status: res.status, text: txt, json };
  }

  async function main() {
    // 0) 最低限チェック
    if (!GAS_ENDPOINT || GAS_ENDPOINT.includes("ここにGAS")) {
      setStatus("エラー：GAS_ENDPOINT が未設定です（index.html に貼ってね）", false);
      return;
    }

    // 1) 起動情報
    logDebug("起動URL: " + location.href);
    logDebug("UA: " + navigator.userAgent);

    try {
      setStatus("LIFF 初期化中…");

      // 2) init（タイムアウトが怖いので明示で10秒）
      const initPromise = liff.init({ liffId: LIFF_ID });
      const timeoutPromise = new Promise((_, rej) => setTimeout(() => rej(new Error("liff.init が10秒でタイムアウトしました")), 10000));
      await Promise.race([initPromise, timeoutPromise]);

      // 3) ログインしてなければログインへ
      if (!liff.isLoggedIn()) {
        setStatus("未ログイン → ログイン画面へ…");
        // redirectUri は「今開いてるURL」に固定（余計なズレ防止）
        liff.login({ redirectUri: location.href });
        return;
      }

      setStatus("ログイン済み → プロフィール取得中…");

      // 4) profile（10秒タイムアウト）
      const profPromise = liff.getProfile();
      const timeoutPromise2 = new Promise((_, rej) => setTimeout(() => rej(new Error("getProfile が10秒でタイムアウトしました")), 10000));
      const profile = await Promise.race([profPromise, timeoutPromise2]);

      const userId = profile?.userId || "";
      const displayName = profile?.displayName || "";

      $("userId").textContent = userId || "（空）";
      $("displayName").textContent = displayName || "（空）";

      if (!userId) {
        setStatus("エラー：userId が取れません（Scope=profile を確認）", false);
        return;
      }

      setStatus("GASへ送信中…");

      // 5) GASへ自動送信
      const payload = {
        userId,
        displayName,
        ua: navigator.userAgent,
        liffUrl: location.href,
      };

      logDebug({ payload });

      const r = await postToGas(payload);

      $("resultText").textContent = r.json ? JSON.stringify(r.json, null, 2) : r.text;

      if (r.json && r.json.ok) {
        $("result").className = "card ok";
        setStatus("完了：スプレッドシートに保存しました ✅");
      } else {
        $("result").className = "card ng";
        setStatus("エラー：GASがOKを返していません（結果を見てね）", false);
      }

    } catch (err) {
      $("result").className = "card ng";
      $("resultText").textContent = String(err);
      setStatus("エラー：" + String(err), false);
      logDebug("ERROR: " + String(err));
    }
  }

  main();
</script>
</body>
</html>
