<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出勤確認</title>
  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; margin: 14px; background:#fafafa; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius:14px; padding:14px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    h1 { font-size:18px; margin:0 0 10px; }
    .row { display:grid; gap:10px; }
    .btns { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    input { width:100%; padding:12px; border-radius:12px; border:1px solid #ddd; font-size:16px; }
    button { width:100%; padding:12px; border-radius:12px; border:0; font-size:16px; font-weight:700; cursor:pointer; }
    .primary { background:#111; color:#fff; }
    .ghost { background:#eee; color:#333; }
    .ghost[disabled] { opacity:.4; cursor:not-allowed; }
    .msg { margin-top:10px; font-size:14px; white-space:pre-line; }
    .ok { color:#0a7a2f; }
    .ng { color:#b00020; }
    .meta { font-size:12px; color:#666; margin-top:8px; }

    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal { width:min(380px, 92vw); background:#fff; border-radius:16px; padding:14px; }
    .spinner { width:20px; height:20px; border:3px solid #ddd; border-top:3px solid #111; border-radius:999px; animation: spin 0.8s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .bar { height:10px; background:#eee; border-radius:999px; overflow:hidden; margin-top:10px; }
    .bar > div { height:100%; width:0%; background:#111; transition: width .2s; }
    .small { font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>出勤確認</h1>

    <div class="row">
      <div>
        <div class="small">スタッフコード</div>
        <input id="staffCode" placeholder="例：U1234 / 1234" autocomplete="off" />
      </div>

      <div>
        <div class="small">店舗（任意）</div>
        <input id="store" placeholder="例：マルハン千葉北店" autocomplete="off" />
      </div>
    </div>

    <div class="btns">
      <button id="backBtn" class="ghost" disabled>戻る</button>
      <button id="sendBtn" class="primary">登録</button>
    </div>

    <div id="msg" class="msg"></div>
    <div id="meta" class="meta"></div>
  </div>

  <div id="overlay" class="overlay">
    <div class="modal">
      <div><span class="spinner"></span><span id="loadingText">処理中…</span></div>
      <div class="bar"><div id="bar"></div></div>
      <div id="pct" class="small">0%</div>
    </div>
  </div>

<script>
  // ★ここを差し替え（GASの「ウェブアプリURL」）
  // 例：https://script.google.com/macros/s/XXXXXXXXXXXX/exec
  const GAS_WEBAPP_URL = "【ここにGASのWebアプリURL】";

  const elStaff = document.getElementById("staffCode");
  const elStore = document.getElementById("store");
  const elMsg   = document.getElementById("msg");
  const elMeta  = document.getElementById("meta");
  const backBtn = document.getElementById("backBtn");
  const sendBtn = document.getElementById("sendBtn");
  const overlay = document.getElementById("overlay");
  const bar = document.getElementById("bar");
  const pct = document.getElementById("pct");
  const loadingText = document.getElementById("loadingText");

  let historyStack = [];

  function setMsg(text, ok) {
    elMsg.textContent = text || "";
    elMsg.className = "msg " + (ok ? "ok" : "ng");
  }
  function setMeta(text) {
    elMeta.textContent = text || "";
  }

  function startLoading(text) {
    loadingText.textContent = text || "処理中…";
    overlay.style.display = "flex";
    setProgress(5);
    sendBtn.disabled = true;
    backBtn.disabled = historyStack.length === 0;
  }
  function endLoading() {
    setProgress(100);
    setTimeout(() => {
      overlay.style.display = "none";
      sendBtn.disabled = false;
      backBtn.disabled = historyStack.length === 0;
      setProgress(0);
    }, 200);
  }
  function setProgress(p) {
    const v = Math.max(0, Math.min(100, p));
    bar.style.width = v + "%";
    pct.textContent = v + "%";
  }

  function normalizeStaffCode(v){
    return String(v || "").trim().toUpperCase(); // ★U系を絶対落とさない
  }

  async function postApi(payload){
    // ★CORSの事前リクエストを避けるため、Content-Type は text/plain で送る
    const res = await fetch(GAS_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
    });
    return await res.json();
  }

  async function refreshStatus(){
    try{
      const r = await postApi({ action:"status" });
      if (r && r.ok){
        setMeta(`今日：${r.date} / 確認：${r.confirmed}/${r.total_shift} / 未確認：${r.unconfirmed} / サーバー：${r.server_time}`);
      } else {
        setMeta("");
      }
    } catch(e){
      setMeta("");
    }
  }

  backBtn.addEventListener("click", () => {
    if (historyStack.length === 0) return;
    const prev = historyStack.pop();
    elStaff.value = prev.staffCode;
    elStore.value = prev.store;
    setMsg("", true);
    backBtn.disabled = historyStack.length === 0;
  });

  sendBtn.addEventListener("click", async () => {
    const staffCode = normalizeStaffCode(elStaff.value);
    const store = String(elStore.value || "").trim();

    if (!staffCode) { setMsg("スタッフコードを入力してください", false); return; }

    historyStack.push({ staffCode, store });
    backBtn.disabled = historyStack.length === 0;

    setMsg("", true);
    startLoading("登録しています…");
    setProgress(20);

    try{
      const r = await postApi({ action:"confirm", staffCode, store });
      setProgress(80);

      if (r && r.ok){
        setMsg(r.message || "OK", true);
        await refreshStatus();
      } else {
        setMsg((r && r.message) ? r.message : "NG", false);
      }
    } catch(e){
      setMsg("ERROR: " + (e && e.message ? e.message : e), false);
    } finally {
      endLoading();
    }
  });

  // 初期表示
  setMsg("スタッフコードを入力して「登録」を押してください。", true);

  // ★日付ズレ対策：ページを開いたら即 status（GAS側のJST“今日”を表示）
  refreshStatus();

  // ★0:00跨ぎ対策：60秒ごとにstatus更新（軽い）
  setInterval(refreshStatus, 60000);
</script>
</body>
</html>
