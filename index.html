<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出勤一覧</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#f5f6f8;margin:0;padding:14px;}
    .wrap{max-width:560px;margin:0 auto;}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:18px;}
    h1{margin:6px 0 10px;text-align:center;font-size:26px;}
    .sub{text-align:center;color:#666;font-size:14px;margin-bottom:6px;}
    .pill{display:inline-block;background:#eef0f3;border-radius:999px;padding:6px 10px;font-size:14px;}
    .center{text-align:center;}
    .btnrow{display:flex;gap:10px;justify-content:center;margin:12px 0 10px;}
    .btn{border:0;border-radius:10px;padding:10px 16px;color:#fff;font-weight:700;font-size:15px;cursor:pointer;}
    .btn.blue{background:#1976d2;}
    .btn.green{background:#2e7d32;}
    .status{margin:10px 0 0;text-align:center;color:#444;font-size:14px;min-height:20px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;font-size:15px;vertical-align:middle;}
    th{color:#666;font-weight:700;background:#fafafa;}
    .muted{color:#777;}
    .debug{display:none;margin-top:10px;background:#111;color:#e8e8e8;border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;}
    .spin{display:none;margin:8px auto 0;width:18px;height:18px;border-radius:50%;border:3px solid #ddd;border-top-color:#333;animation:rot .8s linear infinite;}
    @keyframes rot{to{transform:rotate(360deg)}}

    .btnSmall{border:0;border-radius:10px;padding:8px 10px;font-weight:800;font-size:13px;color:#fff;cursor:pointer;min-width:72px;}
    .btnRed{background:#d32f2f;}
    .btnDone{background:#2e7d32;}
    .btnGray{background:#bdbdbd; cursor:not-allowed;}
    .selfTag{display:inline-block;font-size:11px;font-weight:800;margin-left:6px;background:#ffe8e8;color:#b71c1c;border-radius:999px;padding:2px 8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>出勤一覧</h1>

      <div class="sub">ログイン中：<span id="loginName">-</span></div>
      <div class="center"><span class="pill">表示日：<span id="viewDate">-</span></span></div>

      <div class="btnrow">
        <button class="btn blue" id="btnReload">再読み込み</button>
        <button class="btn green" id="btnDebug">デバッグ表示</button>
      </div>

      <div class="spin" id="loading"></div>

      <table>
        <thead>
          <tr>
            <th style="width:34%">店名</th>
            <th style="width:26%">開始日時</th>
            <th style="width:26%">名前</th>
            <th style="width:14%">操作</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="muted" colspan="4" style="text-align:center">読み込み中…</td></tr>
        </tbody>
      </table>

      <div class="status" id="statusText"></div>
      <div class="debug" id="debugBox"></div>
    </div>
  </div>

<script>
  // ★ここは必ず「GAS WebApp URL（/exec）」を入れる
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwqydPjkvk1bDvN4zlBxht64q5o-Grqe0O4oMG408zp09oFci9uB5-UG8qwiQf1vUEWEA/exec";

  // ★あなたのLIFF ID（固定）
  const LIFF_ID = "2008802899-oJWsorEf";

  let debugOn = false;
  let inflight = false;

  let myUserId = "";
  let myDisplayName = "";
  let myStaffCode = "";
  let myName = "";
  let meOk = false;

  const elLoginName = document.getElementById("loginName");
  const elViewDate  = document.getElementById("viewDate");
  const elTbody     = document.getElementById("tbody");
  const elStatus    = document.getElementById("statusText");
  const elDebug     = document.getElementById("debugBox");
  const elLoading   = document.getElementById("loading");

  function setLoading(on){ elLoading.style.display = on ? "block" : "none"; }
  function setStatus(msg){ elStatus.textContent = msg || ""; }
  function setDebug(text){
    elDebug.textContent = text || "";
    elDebug.style.display = debugOn ? "block" : "none";
  }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  // JSONPヘルパー
  function jsonp_(url) {
    return new Promise((resolve, reject) => {
      const cb = "__cb_" + Date.now() + "_" + Math.floor(Math.random()*1000);
      const timeout = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 15000);

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cb]; } catch(_) {}
        if (sc && sc.parentNode) sc.parentNode.removeChild(sc);
      }

      window[cb] = (data) => { cleanup(); resolve(data); };

      const sc = document.createElement("script");
      sc.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb) + "&t=" + Date.now();
      sc.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
      document.body.appendChild(sc);
    });
  }

  // GAS: me
  async function fetchMe_(){
    if(!myUserId) return { ok:false, message:"no userId" };
    const url = `${GAS_URL}?action=me&userId=${encodeURIComponent(myUserId)}&displayName=${encodeURIComponent(myDisplayName||"")}`;
    const data = await jsonp_(url);
    return data;
  }

  // GAS: list
  async function fetchList_(){
    const url = `${GAS_URL}?action=list`;
    const data = await jsonp_(url);
    return data;
  }

  // GAS: apply（自分の申請）
  async function apply_(){
    if(!myUserId) throw new Error("no userId");
    const url = `${GAS_URL}?action=apply&userId=${encodeURIComponent(myUserId)}&displayName=${encodeURIComponent(myDisplayName||"")}`;
    const data = await jsonp_(url);
    return data;
  }

  function renderRows(rows){
    if(!rows || !rows.length){
      elTbody.innerHTML = `<tr><td class="muted" colspan="4" style="text-align:center">出勤者がいません</td></tr>`;
      return;
    }

    elTbody.innerHTML = rows.map(r => {
      const staffCode = String(r.staffCode || "");
      const isSelf = (meOk && myStaffCode && staffCode === myStaffCode);
      const confirmed = !!r.confirmed;

      // ボタンルール：
      // 自分×未完了 → 申請（赤）押せる
      // 自分×完了   → 完了（緑）押せない
      // 他人×未完了 → グレー 押せない
      // 他人×完了   → 完了（緑）押せない（表示のみ）
      let btnHtml = "";
      if (confirmed) {
        btnHtml = `<button class="btnSmall btnDone" disabled>完了</button>`;
      } else if (isSelf) {
        btnHtml = `<button class="btnSmall btnRed" data-action="apply" data-code="${esc(staffCode)}">申請</button>`;
      } else {
        btnHtml = `<button class="btnSmall btnGray" disabled>未</button>`;
      }

      const nameCell = esc(r.name||"") + (isSelf ? `<span class="selfTag">自分</span>` : "");

      return `
        <tr>
          <td>${esc(r.store||"")}</td>
          <td>${esc(r.start||"")}</td>
          <td>${nameCell}</td>
          <td style="text-align:right">${btnHtml}</td>
        </tr>
      `;
    }).join("");
  }

  async function initLiff_(){
    try{
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        // 外部ブラウザ等
        elLoginName.textContent = "（LINEで開いてください）";
        return;
      }

      const prof = await liff.getProfile();
      myUserId = prof.userId || "";
      myDisplayName = prof.displayName || "";

      // GASに「このuserIdは誰？」を問い合わせ
      const me = await fetchMe_();
      if (me && me.ok) {
        meOk = true;
        myStaffCode = me.staffCode || "";
        myName = me.name || "";
        elLoginName.textContent = `${myDisplayName}${myStaffCode ? "（" + myStaffCode + "）" : ""}`;
      } else {
        meOk = false;
        elLoginName.textContent = `${myDisplayName}（未登録）`;
        setStatus(me?.message || "staff未登録");
      }

    }catch(e){
      elLoginName.textContent = "（LIFF初期化失敗）";
      setDebug(String(e));
    }
  }

  async function loadAll(){
    if(inflight) return;
    inflight = true;
    setLoading(true);
    setStatus("読み込み中…");

    try{
      const list = await fetchList_();
      if (!list || list.ok === false) {
        throw new Error(list?.message || list?.error || "server_ng");
      }

      elViewDate.textContent = list.viewDate || list.today || "-";
      renderRows(list.rows || []);
      setStatus("一覧を更新しました");
      setDebug(JSON.stringify({ me:{meOk,myUserId,myStaffCode,myName,myDisplayName}, list }, null, 2));

    }catch(e){
      setStatus("読み込み失敗");
      renderRows([]);
      setDebug(String(e));
    }finally{
      setLoading(false);
      inflight = false;
    }
  }

  // 申請ボタン（イベント委譲）
  elTbody.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button[data-action='apply']");
    if(!btn) return;

    // 自分以外は押せない設計（UI側）
    if(!meOk || !myStaffCode) return;

    // 二重押し防止
    if(inflight) return;

    inflight = true;
    setLoading(true);
    setStatus("申請中…");

    try{
      const res = await apply_();
      if (!res || res.ok === false) {
        throw new Error(res?.message || res?.error || "apply_ng");
      }
      // 申請したら再読み込みして完了表示に切替
      await loadAll();
      setStatus("申請しました（完了）");
    }catch(e){
      setStatus("申請失敗");
      setDebug(String(e));
    }finally{
      setLoading(false);
      inflight = false;
    }
  });

  document.getElementById("btnReload").addEventListener("click", loadAll);
  document.getElementById("btnDebug").addEventListener("click", () => {
    debugOn = !debugOn;
    elDebug.style.display = debugOn ? "block" : "none";
  });

  document.addEventListener("DOMContentLoaded", async () => {
    await initLiff_();
    await loadAll();
  });
</script>
</body>
</html>
